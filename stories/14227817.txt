In a passing remark in “The Drunkard’s Walk,” Leonard Mlodinow points out that random shuffle mode on the Apple iPod is rigged to avoid situations that would arise in true random mode but were perceived as non-randomness by listeners. Mlodinow quotes Steve Jobs as saying that they made the feature “less random to make it feel more random.” I had forgotten all about that when during a recent drive across the Great Basin of Nevada, it occurred to me that random shuffle mode on my iPod—or any other music player that I have used, for that matter—never seemed to play an unbroken pair, that is, two consecutive songs that were also consecutive in the same order on the original, unshuffled playlist.

Pilot Peak, Elevation 10,719 ft (3,267 m), in the Great Basin of Nevada

Knowing that the human mind’s ability to intuit matters of randomness and probability is dismal, I had to admit to myself that I had no idea how likely it is for such a consecutive pair to occur in true random mode. (We’ll discuss what “true random mode” might mean in this context in a moment.) Central Nevada being the perfect place to cleanse one’s mind of preconceived notions, I started thinking about the problem of counting the permutations of the integers 1, 2, …, n that have consecutive pairs in the above sense. Again, for the not-so-mathematically inclined, I’ll explain permutations in more detail in a moment. By the time I reached the nearest geek-friendly independent coffeehouse—and there is a pleasantly large number of them in small Nevada towns such as Elko, Winnemucca, or Lovelock—I had, to my utmost frustration, not come anywhere close to having an answer.

Web search quickly led me to this answer on Quora, where Jed Yang gives a simple recursive formula with a lucid, concise proof for the number of permutations of n elements with no consecutive pairs. I found his solution very satisfying and enjoyable insofar as it does not rely on prior mathematical results, but instead feels like solving a rather challenging puzzle. Implementing the algorithm is a simple task [1]. Thus I was able to make this chart of the probability of hearing a consecutive pair in random shuffle mode, that is, two consecutive songs that are also consecutive in the same order on the original playlist, as a function of the size of the playlist:

We see that the probability of hearing a consecutive pair in a shuffled playlist of commonly encountered size is well above 50%. This means that if you listen to such a playlist in shuffle mode a large number of times, you will hear one or more consecutive pairs more than half the time. Since this has never happened to me [2], I am led to believe that avoiding consecutive pairs is one of the things, perhaps even the only thing, that they do when they make random shuffle mode, in Steve Jobs’ words, “less random to make it seem more random.” We’ll talk about that some more in a moment.

As always happens, answering one question leads to a bunch more. The first ones that popped into my mind were, “What is the probability of hearing three songs in a row, that is, to get a consecutive triple? Four songs in a row, that is, a consecutive quadruple? A consecutive k-tuple?” You can easily make up more questions of that nature. Not surprisingly, further Web search revealed that there is a vast body of existing work in that realm [3]. But I also had some questions to which I could not find the answers on the Web. I’ll mention one near the end of this blog post. So I sat down and figured out a general algorithm that allowed me to answer a large class of questions regarding consecutive sequences in permutations. I wrote it up with proof in the style of a mathematical article, implemented it, put the code up on github, and made some charts that I’ll show you in a moment [4]. Any feedback on the algorithms and the mathematical proofs from people with expertise in combinatorical mathematics and algorithm discovery would be much appreciated.

Before I show you some of the things that I found out, here is some combinatorial background for the mathematical layperson. Let n be a positive integer. A permutation of the numbers 1, 2, …, n is an arrangement of those numbers in some order. For example, some permutations of the numbers 1, 2, 3, 4 are (1, 2, 3, 4), (4, 3, 2, 1), and (2, 4, 3, 1). In this example, the total number of permutations is 24. For n elements, the number of permutations is

Mathematicians denote this product by n! and pronounce it “n factorial.” For the first few positive integers, starting at 2, the values of n! are 2, 6, 24, 120, 720, 5040. Now try to guess what 60! is, ballparkwise. Wrong. It is a number that roughly equals the number of atoms in the known, observable universe. So much for the human mind’s ability to intuit matters of combinatorics and probability.

Now what does this have to do with random shuffle mode on your music player? I haven’t found any information at all on what companies like Apple do in order to implement shuffle mode. But I am willing to speculate that their default approach, before applying any modifications to make it “less random to make it seem more random,” goes like this. Map the songs on the playlist one-to-one to the numbers 1, 2, …, n by assigning 1 to the first song, 2 to the second, and so on. Then generate a random permutation of those numbers and play the songs in that order [5].

So then how do they do that, generate a random permutation, or shuffling as you may want to call it, of the numbers 1, 2, …, n? The topic of shuffling algorithms is not quite trivial. Let’s just say that it’s a solved problem. Next, suppose that my earlier conjecture is correct: they do rig the random selection of a permutation to eliminate consecutive pairs, that is, occurrences of two consecutive numbers back-to-back in their permutations. How do they do that? Absent any further requirements, that’s easy to do. Here’s a little puzzle for you. Prove that the following method of eliminating consecutive pairs from a permutation works. Go through the permutation left to right. Every time you encounter a consecutive pair, that is, two consecutive numbers back-to-back, switch them. Done. Hint: it is clear that each switcheroo eliminates the consecutive pair that you just encountered. What you need to prove is that you’re not creating any new ones. I would assume that your music player performs some sort of on-the-fly variant of that simple algorithm [6].

Finally, to wrap up this discussion of basics, we need to discuss how to get from the counting of permutations to the probability of drawing a random permutation with a certain property, like having a consecutive pair. You may be surprised to hear that this is an issue that is somewhat controversial among statisticians [7]. This is certainly not the place to get into that debate. But we need a working definition, so let me tell you how I wrap my head around this. I imagine myself living during an era like the French Revolution. Given my compulsion to run off my big mouth, I am soon sentenced to die on the guillotine. After blindfolding me, the executioner says, “You clearly deserve to die, but hey, we’re not monsters. We’ll give you a chance. Here’s an urn with black and white balls in it. Pick one. If you pick the right color, you’ll live.” And I say, “What do you mean, the right color? Which one is right?” And he says, “Oh, I haven’t thought about that. Your choice.” And I’m like, “Well, how many of each color are there?” And he says, “I don’t know, let me count real quick, one, two, three, … looks like there’s 20 white ones and 5 black ones. Now come on, pick a color and pick a ball. I don’t have all day.” Given the urgency of the matter, I can’t think of a better way of measuring the odds of picking a color than to look at the fraction of white balls in the urn vs. the fraction of black balls. I’d say the fact that 20 of 25 balls are white means that I should peg the odds of picking a white ball at 20/25, that is, .8, or 80%. There it is, one way of defining probability. Whenever I need to calculate a probability, like when I made those charts, I repeat this little mnemonic mantra to myself: the probability of a favorable outcome is the number of favorable choices divided by the total number of choices.

Applying this to the issue at hand, we can say, “The probability of getting a permutation with property X, like containing a consecutive pair, on an unrigged music player equals the number of permutations with property X divided by the total number of permutations.” Since we always know what the total number of permutations is, namely, n factorial, we have thus reduced the problem to counting the permutations with property X. And given the astronomical number of permutations of a playlist of no more than moderate size, we also know that we cannot do this by actually examining each permutation and checking if it has property X. Therein lies is the power and the fascination of mathematical results like the aforementioned algorithm for the number of permutations without consecutive pairs.

As I said before, once you start thinking about consecutive pairs in permutations of the integers 1, 2, 3, …,n, all kinds of question start tickling your mind. The first chart above showed us the probability of having consecutive pairs, any number, any arrangement, including linked consecutive pairs that form longer consecutive sequences. The chart below shows you the probabilities of seeing consecutive triples, quadruples, and quintuples. Note that under this terminology, a consecutive sequence of length k can be part of a longer consecutive sequence. For example, the permutation (2, 3, 4, 5, 1) has three consecutive pairs, two consecutive triples, and one consecutive quadruple.

We see that the probability of consecutive sequences of length greater than 2 tends to be small, and it decreases with the number of elements that are being permuted. So the bulk of that fat probability of having consecutive pairs at all that we saw in the first chart comes from isolated consecutive pairs, that is, consecutive pairs that are not linked, that do not form longer consecutive sequences. Indeed, if we look at the probability of having one or more consecutive pairs but no consecutive sequences of length greater than 2, we get a chart that looks a lot like our first chart. The absence of the longer consecutive sequences is hardly felt.

At this point, I wanted to know how much of that probability is contributed by permutations with exactly one consecutive pair, exactly two isolated ones, exactly three isolated ones, etc. The chart below has answers. The probabilities are for exactly x number of isolated consecutive pairs and no other consecutive sequences. And by the way, this is an example of where the Web failed me: I could not find the answer for x > 2. This was the stepping stone to my all-purpose algorithm.

Perhaps not surprisingly, the better part of the probability of having isolated consecutive pairs comes from permutations with exactly one consecutive pair. That probability looks a lot like it converges very quickly to a number near 0.36787944117. There is a law of nature saying that every mathematical solution to a real-life, everyday problem will eventually lead you to π, e, or the Fibonacci sequence. Now go enter “1/e” in your search box, calculator, or spreadsheet.|||

Some Mathematics, Algorithms, and Probabilities...